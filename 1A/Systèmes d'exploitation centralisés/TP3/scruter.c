#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/wait.h>
#include <string.h>
#include <fcntl.h>

#define NOMBRE_FILS 2
#define SLEEP_TIME 2
#define DISPLAY_SLEEP_TIME 5

/* La fonction scruter() */
int main() {
    int codeTerm, ret, fdEcrire, fdLire, i, fils, writeRet, readRet, intBuf;
    for (fils = 1; fils <= NOMBRE_FILS; fils++) {
        ret = fork();
        if (ret == -1) {
            perror("Erreur lors de la création du fils");
            exit(EXIT_FAILURE);
        } else if (ret == 0) {
            if (fils == 1) {
                // on ouvre le fichier temp et on ecrit les entiers de 1 à 30
                fdEcrire = open("temp", O_WRONLY | O_CREAT, 0644);
                if (fdEcrire == -1) {
                    perror("Erreur lors de l'ouverture du fichier temp");
                    exit(EXIT_FAILURE);
                }
                for (i = 1; i <= 30; i++) {
                    /* placer la tete en début de fichier tous les 10 entiers */
                    if (i % 10 == 1) {
                        lseek(fdEcrire, 0, SEEK_SET);
                    }
                    /* écrire l'entier dans le fichier */
                    writeRet = write(fdEcrire, &i, sizeof(int));
                    if (writeRet == -1) {
                        perror("Erreur lors de l'écriture dans le fichier temp");
                        exit(EXIT_FAILURE);
                    }
                    /* attendre 2 secondes */
                    sleep(SLEEP_TIME);
                }
                close(fdEcrire);
                exit(EXIT_SUCCESS);
            }
            if (fils == 2) {
                /* affiche les 30 entiers du fichier temp toutes les 10 secondes */
                fdLire = open("temp", O_RDONLY);
                if (fdLire == -1) {
                    perror("Erreur lors de l'ouverture du fichier temp");
                    exit(EXIT_FAILURE);
                }
                for (i = 1; i <= 30; i++) {
                    /* placer la tete en début de fichier */
                    lseek(fdLire, 0, SEEK_SET);
                    /* lire l'entier dans le fichier */
                    readRet = read(fdLire, &intBuf, sizeof(int));
                    while (readRet > 0) {
                        /* afficher l'entier */
                        printf("%d\n", intBuf);
                        /* attendre 5 secondes */
                        sleep(DISPLAY_SLEEP_TIME);
                        /* lire l'entier suivant */
                        readRet = read(fdLire, &intBuf, sizeof(int));
                    }    
                }
                    /* afficher l'entier */
                    printf("%d\n", i);
                    /* attendre 5 secondes */
                    sleep(DISPLAY_SLEEP_TIME);
                close(fdLire);
                exit(EXIT_SUCCESS);
            }
        } else {
            /* attendre la fin des fils */
            for (fils = 1; fils <= NOMBRE_FILS; fils++) {
                ret = wait(&codeTerm);
                if (ret == -1) {
                    perror("Erreur lors de l'attente de la fin du fils");
                    exit(EXIT_FAILURE);
                }
            }
            /* supprimer le fichier temp */
            ret = unlink("temp");
            if (ret == -1) {
                perror("Erreur lors de la suppression du fichier temp");
                exit(EXIT_FAILURE);
            }
            /* Sortie du programme */
            return EXIT_SUCCESS;
        }
    }
    return EXIT_SUCCESS;
}
    