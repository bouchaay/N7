#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>

// Création des pipes pour l'exécution des commandes : who | grep nom utilisateur | wc -l

int main(int argc, char *argv[]) {
    
    int p1[2], p2[2];

    int pipe1 = pipe(p1);
    if (pipe1 == -1) {
        perror("pipe1");
        exit(1);
    }

    int ret1 = fork();
    if (ret1 == -1) {
        perror("fork1");
        exit(1);
    } else if (ret1 == 0) {
        // Fils 1
        close(p1[0]);
        dup2(p1[1], 1);
        close(p1[1]);
        execlp("who", "who", NULL);
        perror("exec1");
        exit(1);
    } else {
        // Père
        int pipe2 = pipe(p2);
        if (pipe2 == -1) {
            perror("pipe2");
            exit(1);
        }

        int ret2 = fork();
        if (ret2 == -1) {
            perror("fork2");
            exit(1);
        } else if (ret2 == 0) {
            // Fils 2
            close(p1[1]);
            dup2(p1[0], 0);
            close(p1[0]);
            close(p2[0]);
            dup2(p2[1], 1);
            close(p2[1]);
            execlp("grep", "grep", argv[1], NULL);
            perror("exec2");
            exit(1);
        } else {
            // Père
            close(p1[0]);
            close(p1[1]);
            close(p2[1]);
            dup2(p2[0], 0);
            close(p2[0]);
            execlp("wc", "wc", "-l", NULL);
            perror("exec3");
            exit(1);
        }
    }
}
